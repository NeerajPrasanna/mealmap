<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MealMap Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc,
      getDocs, collection
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    // --- Firebase Config ---
    const firebaseConfig = {
      apiKey: "AIzaSyDvRN3BXwGXKLUn9TJFv5kYcQCucSM5-2Y",
      authDomain: "mealmap-123.firebaseapp.com",
      projectId: "mealmap-123",
      storageBucket: "mealmap-123.firebasestorage.app",
      messagingSenderId: "517057007840",
      appId: "1:517057007840:web:9efa6b0ac945f803e08085",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- DOM Elements ---
    const fridgeTableBody = document.getElementById("fridgeTableBody");
    const fridgeForm = document.getElementById("fridgeForm");
    const loadingSpinner = document.getElementById("loadingSpinner");

    const modal = document.getElementById("fridgeModal");
    const modalTitle = document.getElementById("modalTitle");
    const modalFridgeId = document.getElementById("modalFridgeId");
    const modalLocation = document.getElementById("modalLocation");
    const modalStatus = document.getElementById("modalStatus");
    const modalTemp = document.getElementById("modalTemp");
    const modalHumidity = document.getElementById("modalHumidity");
    const modalFoodList = document.getElementById("modalFood");

    // --- Load Fridges ---
    async function loadFridges() {
      showLoading(true);
      fridgeTableBody.innerHTML = "";
      try {
        const querySnap = await getDocs(collection(db, "refrigerators"));
        querySnap.forEach((docSnap) => {
          const data = docSnap.data();
          const row = document.createElement("tr");
          row.className = "border-b hover:bg-gray-50 transition";
          row.innerHTML = `
            <td class="px-4 py-2 font-semibold">${docSnap.id}</td>
            <td class="px-4 py-2">${data.location}</td>
            <td class="px-4 py-2">
              <span class="px-2 py-1 rounded text-white ${data.status === "active" ? "bg-green-500" : "bg-red-500"}">
                ${data.status}
              </span>
            </td>
            <td class="px-4 py-2">${data.temperature ?? "-"}</td>
            <td class="px-4 py-2">${data.humidity ?? "-"}</td>
            <td class="px-4 py-2 space-x-2">
              <button class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded"
                data-id="${docSnap.id}" data-action="view">View</button>
              <button class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded"
                data-id="${docSnap.id}" data-action="edit">Edit</button>
              <button class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded"
                data-id="${docSnap.id}" data-action="delete">Delete</button>
            </td>
          `;
          fridgeTableBody.appendChild(row);
        });
      } catch (err) {
        console.error("Error loading fridges:", err);
      }
      showLoading(false);
    }

    // --- Save Fridge (Create/Update) ---
    async function saveFridge(e) {
      e.preventDefault();
      const id = fridgeForm.fridgeId.value.trim();
      const location = fridgeForm.location.value.trim();
      const status = fridgeForm.status.value;
      const temperature = parseFloat(fridgeForm.temperature.value) || null;
      const humidity = parseFloat(fridgeForm.humidity.value) || null;
      if (!id || !location) return alert("Please fill required fields.");

      showLoading(true);
      try {
        const fridgeRef = doc(db, "refrigerators", id);
        const snap = await getDoc(fridgeRef);
        if (snap.exists()) {
          await updateDoc(fridgeRef, { location, status, temperature, humidity });
        } else {
          await setDoc(fridgeRef, { location, status, temperature, humidity, foodItems: [] });
        }
        fridgeForm.reset();
        await loadFridges();
      } catch (err) {
        console.error("Save error:", err);
      }
      showLoading(false);
    }

    // --- Delete Fridge ---
    async function deleteFridge(id) {
      if (!confirm(`Delete fridge ${id}?`)) return;
      showLoading(true);
      try {
        await deleteDoc(doc(db, "refrigerators", id));
        await loadFridges();
      } catch (err) {
        console.error("Delete error:", err);
      }
      showLoading(false);
    }

    // --- Edit Fridge (prefill form) ---
    async function editFridge(id) {
      const snap = await getDoc(doc(db, "refrigerators", id));
      if (!snap.exists()) return alert("Fridge not found.");
      const data = snap.data();
      fridgeForm.fridgeId.value = id;
      fridgeForm.location.value = data.location;
      fridgeForm.status.value = data.status;
      fridgeForm.temperature.value = data.temperature ?? "";
      fridgeForm.humidity.value = data.humidity ?? "";
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    // --- View Fridge Details Modal ---
    async function showDetails(id) {
      const snap = await getDoc(doc(db, "refrigerators", id));
      if (!snap.exists()) return alert("Fridge not found.");
      const data = snap.data();
      modalFridgeId.value = id;
      modalTitle.innerText = `Fridge: ${id}`;
      modalLocation.innerText = data.location;
      modalStatus.innerText = data.status;
      modalTemp.innerText = data.temperature ?? "-";
      modalHumidity.innerText = data.humidity ?? "-";
      modalFoodList.innerHTML = "";

      (data.foodItems || []).forEach((item, index) => {
        const li = document.createElement("li");
        li.className = "flex justify-between items-center py-1";
        li.innerHTML = `
          <span>${item.name} (${item.quantity})</span>
          <button data-index="${index}" data-id="${id}"
            class="text-red-500 hover:text-red-700 text-sm">ðŸ—‘</button>`;
        modalFoodList.appendChild(li);
      });

      modal.classList.remove("hidden");
    }

    // --- Close Modal ---
    window.closeModal = () => modal.classList.add("hidden");

    // --- Add Food Item ---
    async function addFoodItem(e) {
      e.preventDefault();
      const id = modalFridgeId.value;
      const name = document.getElementById("foodName").value.trim();
      const quantity = document.getElementById("foodQty").value.trim();
      if (!name || !quantity) return alert("Enter both name and quantity.");

      const ref = doc(db, "refrigerators", id);
      const snap = await getDoc(ref);
      const data = snap.data();
      const updated = [...(data.foodItems || []), { name, quantity }];
      await updateDoc(ref, { foodItems: updated });
      document.getElementById("foodName").value = "";
      document.getElementById("foodQty").value = "";
      showDetails(id);
    }

    // --- Remove Food Item ---
    modalFoodList.addEventListener("click", async (e) => {
      if (e.target.matches("button[data-index]")) {
        const id = e.target.dataset.id;
        const idx = e.target.dataset.index;
        const ref = doc(db, "refrigerators", id);
        const snap = await getDoc(ref);
        const items = snap.data().foodItems || [];
        items.splice(idx, 1);
        await updateDoc(ref, { foodItems: items });
        showDetails(id);
      }
    });

    // --- Event Delegation for Table Buttons ---
    fridgeTableBody.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-id]");
      if (!btn) return;
      const id = btn.dataset.id;
      const action = btn.dataset.action;
      if (action === "view") showDetails(id);
      if (action === "edit") editFridge(id);
      if (action === "delete") deleteFridge(id);
    });

    // --- Loading Spinner ---
    function showLoading(show) {
      loadingSpinner.classList.toggle("hidden", !show);
    }

    // --- Init ---
    fridgeForm.addEventListener("submit", saveFridge);
    document.getElementById("refreshBtn").addEventListener("click", loadFridges);
    document.getElementById("addFoodForm").addEventListener("submit", addFoodItem);
    window.addEventListener("load", loadFridges);
  </script>
</head>

<body class="flex min-h-screen bg-gray-100">
  <!-- Sidebar -->
  <aside class="w-64 bg-gray-800 text-white flex flex-col">
    <div class="p-6 text-2xl font-bold border-b border-gray-700">MealMap Admin</div>
    <nav class="flex-1 p-4 space-y-2">
      <a href="#" class="block px-3 py-2 rounded hover:bg-gray-700">Dashboard</a>
      <a href="#" class="block px-3 py-2 rounded bg-gray-700">Fridges</a>
      <a href="#" class="block px-3 py-2 rounded hover:bg-gray-700">Logs</a>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 p-6 overflow-auto">
    <header class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-semibold text-gray-800">Fridge Manager</h1>
      <button id="refreshBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
        Refresh
      </button>
    </header>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="hidden text-center py-4">
      <div class="animate-spin border-t-4 border-blue-500 border-solid rounded-full w-10 h-10 mx-auto"></div>
    </div>

    <!-- Add/Update Form -->
    <section class="bg-white p-6 rounded-lg shadow mb-6">
      <h2 class="text-xl font-semibold mb-4">Add / Update Fridge</h2>
      <form id="fridgeForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input name="fridgeId" placeholder="Fridge ID" class="border p-2 rounded" required>
        <input name="location" placeholder="Location" class="border p-2 rounded" required>
        <select name="status" class="border p-2 rounded">
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
        </select>
        <input name="temperature" type="number" placeholder="Temperature (Â°C)" class="border p-2 rounded">
        <input name="humidity" type="number" placeholder="Humidity (%)" class="border p-2 rounded">
        <button class="bg-green-600 hover:bg-green-700 text-white py-2 rounded col-span-1 md:col-span-2">
          Save Fridge
        </button>
      </form>
    </section>

    <!-- Fridges Table -->
    <section class="bg-white p-6 rounded-lg shadow">
      <h2 class="text-xl font-semibold mb-4">Fridges List</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full border text-sm">
          <thead class="bg-gray-200 text-gray-700">
            <tr>
              <th class="px-4 py-2">ID</th>
              <th class="px-4 py-2">Location</th>
              <th class="px-4 py-2">Status</th>
              <th class="px-4 py-2">Temp (Â°C)</th>
              <th class="px-4 py-2">Humidity (%)</th>
              <th class="px-4 py-2">Actions</th>
            </tr>
          </thead>
          <tbody id="fridgeTableBody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Modal -->
  <div id="fridgeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-lg relative">
      <button onclick="closeModal()" class="absolute top-3 right-4 text-2xl text-gray-500">&times;</button>
      <h2 id="modalTitle" class="text-2xl font-bold mb-4">Fridge Details</h2>
      <input type="hidden" id="modalFridgeId" />
      <p><strong>Location:</strong> <span id="modalLocation"></span></p>
      <p><strong>Status:</strong> <span id="modalStatus"></span></p>
      <p><strong>Temperature:</strong> <span id="modalTemp"></span> Â°C</p>
      <p><strong>Humidity:</strong> <span id="modalHumidity"></span> %</p>

      <h3 class="font-semibold mt-4 mb-2">Food Items</h3>
      <ul id="modalFood" class="border p-2 rounded bg-gray-50 max-h-40 overflow-y-auto"></ul>

      <form id="addFoodForm" class="mt-4 grid grid-cols-2 gap-2">
        <input id="foodName" placeholder="Food Name" class="border p-2 rounded" required>
        <input id="foodQty" placeholder="Quantity" class="border p-2 rounded" required>
        <button class="col-span-2 bg-green-600 hover:bg-green-700 text-white py-2 rounded">
          Add Food
        </button>
      </form>
    </div>
  </div>
</body>
</html>
